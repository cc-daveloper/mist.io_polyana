<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="panels-element">
    <template>
      <style>
        google-chart {
          height: 300px;
          width: 100%;
          display: block;
        }
        #target{
          color:#000000;
          font-weight: bold;
          text-align: left;
        }
        paper-card{
          width:49%;
          margin-bottom: 20px;
          margin-left: 5px;
          margin-right: 5px;

        }
        #panel_title{
          position: relative;
          margin: 8px;
          height: 90px;
          border: 1px;
          text-align: center;
        }
        #panel_title h2 {
          display: inline;
          background-color:#f1f1f1;
          padding: 16px;
          border-radius: 15px;
          font-size: 24px;
          font-weight: 400;
        }
      </style>
      <div style="display: none;">[[datasourceid]]</div>
      <template is="dom-if" if="[[isDashlist]]">
        <div id="panel_title" elevation="2">
          <h2>[[panel.title]]</h2>
        </div>
        <paper-card elevation="4">
          mydashboards
        </paper-card>
      </template>
      <template is="dom-if" if="[[isText]]">
        <div id="panel_title" elevation="2">
          <h2>[[panel.title]]</h2>
        </div>
        <paper-card elevation="4">
          [[panel.content]]
        </paper-card>
      </template>
      <template is="dom-if" if="[[isSinglestat]]">
        <div id="panel_title" elevation="2">
          <h2>[[panel.title]]</h2>
        </div>
        <paper-card elevation="4">
          [[panel.prefix]] [[panel.postfix]] [[panel.valueMaps[0].op]]
        </paper-card>
      </template>
      <template is="dom-if" if="[[isGraph]]">
        <iron-ajax id="ajax"
        auto
        url="[[_computeUrl()]]"
        headers='{"Authorization": "Bearer eyJrIjoiTDdKaHdKNjJFT05nWU81dHlnYVVkbGdiUmVIY1lYUWkiLCJuIjoibXlrZXkiLCJpZCI6Mn0="}'
        handle-as="json"
        method="GET"
        on-response="_handlePanelRequest"
        debounce-duration="300"></iron-ajax>
        <div id="panel_title" elevation="2">
          <h2>[[panel.title]]<paper-icon-button icon="editor:mode-edit" title="edit"></h2></paper-icon-button>
        </div>
        <template is="dom-repeat" items="[[graphs]]" >
        <paper-card elevation="4">
            <div class="card-content">
              <ul style="list-style-type:square"><li id="target">[[item.target]]</li></ul>
              <google-chart
                id='line_chart'
                type='line'
                options='{"title":""}'
                cols='[{"label": "Time", "type": "string"},{"label": "Percentage", "type": "number"}]'
                rows='[[_reverseDatapoints(item)]]'>
              </google-chart>
            </div>
          </paper-card>
        </template>
      </template>

    </template>
    <script>
      Polymer({
        is: 'panels-element',

        properties: {
          panel: Object,
          editable:Object,
          title: String,
          id: Number,
          type: String,
          datasource: String,
          datasources: Array,
          graphs:Array,
          datasourceid: {type:String, computed:"_datasourceid(datasources,panel)"},
          targets:{type:Array, computed:"getTarget(panel)"},
          values:{type:Array, computed:"getValue(panel)"},
          // datapoints:{type:Array, computed: "getDatapoints(panel)"},
          isGraph:{type:Boolean, computed:"_isGraph(panel)"},
          isDashlist:{type:Boolean, computed:"_isDashlist(panel)"},
          isText:{type:Boolean, computed:"_isText(panel)"},
          isSinglestat:{type:Boolean, computed:"_isSinglestat(panel)"},
          time:{type:Array,computed:"getTime(panel)"}
        },
        _handlePanelRequest(data){
          console.log("hi", data.detail.response);
          this.graphs=data.detail.response;
        },
        _computeUrl: function() {
          console.log('computes url ' +this.datasourceid);
        //  return 'http://localhost:5000/api/datasources/proxy/'+this.datasourceid+'/render?format=json&target=ubuntu.cpu-total.cpu.*&from=-300secs';
        return 'http://localhost:5000/api/datasources/proxy/'+this.datasourceid+'/render?format=json&target='+[[this.panel.targets[0].target]]+'&from=-300secs';

       },
       _isGraph: function(panel){
         if (panel.type == "graph") {
           return true;
         }
         else {
           return false;
         }
       },
       _isDashlist: function(panel){
         if (panel.type == "dashlist") {
           return true;
         }
         else {
           return false;
         }
       },
       _isText: function(panel){
         if (panel.type == "text") {
           return true;
         }
         else {
           return false;
         }
       },
       _isSinglestat: function(panel){
         if (panel.type == "singlestat") {
           return true;
         }
         else {
           return false;
         }
       },
       getTime: function(panel){
         return this.panel.time;
       },
       getTarget: function(panel){
         return this.panel.target;
       },
       getValue:function(panel){
         return this.panel.valueMaps;
       },
       _editPanel:function(){

       },
       _reverseDatapoints: function(item){
         var reversedatapoints = [];
         for (var i=0; i<item.datapoints.length; i++)
         {
           reversedatapoints[i] = [];
           reversedatapoints[i][0]=this._convertUnixtime(item.datapoints[i][1]);
           reversedatapoints[i][1]=item.datapoints[i][0];

         }

         return reversedatapoints;
       },
       _convertUnixtime:function(dtp){
          var date = new Date(dtp*1000);
          // Hours part from the timestamp
          var hours = date.getHours();
          // Minutes part from the timestamp
          var minutes = "0" + date.getMinutes();
          // Seconds part from the timestamp
          var seconds = "0" + date.getSeconds();

          // Will display time in 10:30:23 format
          var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
          return formattedTime;
       },
       _datasourceid: function(datasources,panel){
         if (panel){
         for(var i=0; i<datasources.length; i++){
           if(panel.datasource == datasources[i].name){
             console.log('OKEY', datasources[i].id);
             return datasources[i].id;
           }
         }
       }
       else {
         console.log("no panel");
       }
       }
      });
    </script>
</dom-module>
