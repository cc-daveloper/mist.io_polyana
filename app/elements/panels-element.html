<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="panels-element">
    <template>
      <style>
        google-chart {
          height: 300px;
          width: 400px;
          display: block;
        }
        #target{
          color:#00688B;
          font-weight: bold;
          text-align: left;
        }
        paper-card{
          font-family:Georgia, serif;
          font-weight:bold;width:40%;
          border: 2px solid black;
        }
        paper-button{
          font-family:Georgia, serif;
        }
      </style>
      <div style="display: none;">[[datasourceid]]</div>
      <template is="dom-if" if="[[isGraph]]">
        <iron-ajax id="ajax"
        auto
        url="[[_computeUrl()]]"
        headers='{"Authorization": "Bearer eyJrIjoiTDdKaHdKNjJFT05nWU81dHlnYVVkbGdiUmVIY1lYUWkiLCJuIjoibXlrZXkiLCJpZCI6Mn0="}'
        handle-as="json"
        method="GET"
        on-response="_handlePanelRequest"
        debounce-duration="300"></iron-ajax>
        <template is="dom-repeat" items="[[graphs]]">
        <paper-card>
          <paper-button raised>[[panel.title]]</paper-button>
            <div class="card-content">
              <google-chart
                id='line_chart'
                type='line'
                options='{"title":""}'
                cols='[{"label": "Month", "type": "string"},{"label": "Days", "type": "number"}]'
                rows='[[_reverseDatapoints(item)]]'>
              </google-chart>
              <ul style="list-style-type:square"><li id="target">[[item.target]]</li></ul>
            </div>
          </paper-card>
        </template>

      </template>

    </template>
    <script>
      Polymer({
        is: 'panels-element',

        properties: {
          panel: Object,
          title: String,
          id: Number,
          type: String,
          datasource: String,
          datasources: Array,
          graphs:Array,
          datasourceid: {type:String, computed:"_datasourceid(datasources,panel)"},
          targets:{type:Array, computed:"getTarget(panel)"},
          datapoints:{type:Array, computed: "getDatapoints(panel)"},
          isGraph:{type:Boolean, computed:"_isGraph(panel)"},
          time:{type:Array,computed:"getTime(panel)"}
        },
        _handlePanelRequest(data){
          console.log("hi", data.detail.response);
          this.graphs=data.detail.response;
        },
        _computeUrl: function() {
          console.log('computes url ' +this.datasourceid);
         return 'http://localhost:5000/api/datasources/proxy/'+this.datasourceid+'/render?format=json&target=ubuntu.cpu-total.cpu.*&from=-300secs';
       },
       _isGraph: function(panel){
         if (panel.type == "graph") {
           return true;
         }
         else {
           return false;
         }
       },
       getTime: function(panel){
         return this.panel.time;
       },
       getTarget: function(panel){
         return this.panel.target;
       },
       _editPanel:function(){

       },
       _reverseDatapoints: function(item){
         var reversedatapoints = [];
         for (var i=0; i<item.datapoints.length; i++)
         {
           reversedatapoints[i] = [];
           reversedatapoints[i][0]=this._convertUnixtime(item.datapoints[i][1]);
           reversedatapoints[i][1]=item.datapoints[i][0];

         }

         return reversedatapoints;
       },
       _convertUnixtime:function(dtp){
          var date = new Date(dtp*1000);
          // Hours part from the timestamp
          var hours = date.getHours();
          // Minutes part from the timestamp
          var minutes = "0" + date.getMinutes();
          // Seconds part from the timestamp
          var seconds = "0" + date.getSeconds();

          // Will display time in 10:30:23 format
          var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
          return formattedTime;
       },
       _datasourceid: function(datasources,panel){
         if (panel){
         for(var i=0; i<datasources.length; i++){
           if(panel.datasource == datasources[i].name){
             console.log('OKEY', datasources[i].id);
             return datasources[i].id;
           }
         }
       }
       else {
         console.log("no panel");
       }
       }
      });
    </script>
</dom-module>
