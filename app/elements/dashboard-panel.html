<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/c3-chart/c3-chart.html">
<dom-module id="dashboard-panel">
  <template>
    <style>
      #target {
        font-weight: bold;
        text-align: left;
      }
      paper-card h2 {
        position: relative;
      }
    </style>
    <template is="dom-if" if="[[_isDashlist(panel)]]">
      <paper-card>
        <h2>[[panel.title]]</h2>
        <div><!-- TODO -->...</div>
      </paper-card>
    </template>
    <template is="dom-if" if="[[_isText(panel)]]">
      <div id="panel-title">
      </div>
      <paper-card>
        <h2>[[panel.title]]</h2>
        <div>[[panel.content]]</div>
      </paper-card>
    </template>
    <template is="dom-if" if="[[_isSinglestat(panel)]]">
      <paper-card>
        <h2>[[panel.title]]</h2>
        [[panel.prefix]] [[panel.postfix]] [[panel.valueMaps[0].op]]
      </paper-card>
    </template>
    <template is="dom-if" if="[[_isGraph(panel)]]">
      <h2>[[panel.title]]</h2>
      <c3-chart></c3-chart>
      <iron-ajax auto
        url="[[_computeUrl()]]"
        handle-as="json"
        method="GET"
        on-response="_handlePanelResponse"
        debounce-duration="300"></iron-ajax>
    </template>
    <template is="dom-if" if="[[_isTable(panel)]]">
      <!-- TODO -->
    </template>
  </template>
  <script>
    Polymer({
      is: 'dashboard-panel',

      properties: {
        from: String,
        panel: Object,
        type: String,
        datasources: {
          type: Array,
          value: []
        },
        graphs:Array,
        chartData: {
          type: Object,
          value: {
            xs: {},
            columns: []
          }
        },
        chartAxis: {
          type: Object,
          value: {
            x: {
              type: 'timeseries',
              tick: {
                format: "%H:%M",
                fit: false
              },
              padding: {
                left: 0,
                right: 0
              }
            },
            y: {
              label: {
                position: 'inner-top'
              },
              min: 0,
              padding: {
                bottom: 10
              }
            }
          }
        }
      },

      _handlePanelResponse(data){
        console.log("hi", data.detail.response);
        this.set('graphs', data.detail.response);
        var x = [], d = [], xs = {}, xcolumns = [], dcolumns = [];
        for (var i = 0; i < data.detail.response.length; i++) {
          x.push(data.detail.response[i].datapoints.map(function(point){
            return point[1]
          }));
          d.push(data.detail.response[i].datapoints.map(function(point){
            return point[0]
          }));
          xs[data.detail.response[i].target] = 'x'+(i+1);
          xcolumns.push(['x'+(i+1)].concat(x[i]));
          dcolumns.push([data.detail.response[i].target].concat(d[i]));
        }
        var columns = xcolumns.concat(dcolumns);
        this.set('chartData', {xs: xs, columns: columns});
        this.querySelector('c3-chart').load(this.chartData);
      },

      _computeUrl: function() {
        var targetParams = '';
        for (var i = 0; i < this.panel.targets.length; i++)
          if (this.panel.targets[i].target)
            targetParams += '&target=' + this.panel.targets[i].target
        return '/api/datasources/proxy/' + this._datasourceId(this.datasources, this.panel) + '/render?format=json' + targetParams + '&from=' + this.from;
      },

      _isGraph: function(panel){
        return panel.type == "graph"
      },

      _isDashlist: function(panel){
        return panel.type == "dashlist"
      },

      _isText: function(panel){
        return panel.type == "text"
      },

      _isSinglestat: function(panel){
        return panel.type == "singlestat"
      },

      _isTable: function(panel){
        return panel.type == "table"
      },

      getTarget: function(panel){
        return this.panel.target;
      },

      _reverseDatapoints: function(item){
        var reversedatapoints = [];
        for (var i=0; i<item.datapoints.length; i++)
        {
         reversedatapoints[i] = [];
         reversedatapoints[i][0]=this._convertUnixtime(item.datapoints[i][1]);
         reversedatapoints[i][1]=item.datapoints[i][0];

        }

        return reversedatapoints;
      },

      _convertUnixtime:function(dtp) {
        var date = new Date(dtp*1000);
        // Hours part from the timestamp
        var hours = date.getHours();
        // Minutes part from the timestamp
        var minutes = "0" + date.getMinutes();
        // Seconds part from the timestamp
        var seconds = "0" + date.getSeconds();

        // Will display time in 10:30:23 format
        var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
        return formattedTime;
      },

      _datasourceId: function(datasources, panel) {
        if (panel) {
          for(var i=0; i<datasources.length; i++) {
            if(panel.datasource == datasources[i].name) {
              return datasources[i].id;
            }
          }
        }
      }
    });
  </script>
</dom-module>
