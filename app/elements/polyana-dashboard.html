<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="dashboard-row.html">
<dom-module id="polyana-dashboard">
    <template>
      <style>
        :host{
          text-align: center;
        }
      </style>
      <template is="dom-repeat" items="{{response.dashboard.rows}}">
        <dashboard-row class="row" datasources="[[datasources]]" row="[[item]]" style="height: [[item.height]]" from="[[response.dashboard.time.from]]" id="row-{{index}}"></dashboard-row>
      </template>
      <iron-ajax auto
        url="/api/dashboards/[[uri]]"
        handle-as="json"
        method="GET"
        last-response="{{response}}"
        debounce-duration="300"></iron-ajax>
    </template>
    <script>
        Polymer({
          is: 'polyana-dashboard',

          properties: {
            uri: {
              type: String
            },
            response: {
              type: Object
            },
            datasources: {
              type: Array
            },
            targets: {
              type: Array,
              computed: "_getTargets(response, datasources)"
            },
            datapoints: {
              type: Object
            },
            from: {
              type: String
            }
          },

          _getTargets: function (response, datasources) {
              var targets = {};
              for (var i=0; i<response.dashboard.rows.length; i++) {
                if (response.dashboard.rows[i].panels)
                  for (var j=0; j<response.dashboard.rows[i].panels.length; j++)
                    if (response.dashboard.rows[i].panels[j] && response.dashboard.rows[i].panels[j].targets)
                      for (var k=0; k<response.dashboard.rows[i].panels[j].targets.length; k++) {
                          if (response.dashboard.rows[i].panels[j].datasource && targets[response.dashboard.rows[i].panels[j].datasource] == undefined)
                            targets[response.dashboard.rows[i].panels[j].datasource] = [];
                          if (response.dashboard.rows[i].panels[j].targets[k].target && targets[response.dashboard.rows[i].panels[j].datasource].indexOf(response.dashboard.rows[i].panels[j].targets[k].target)==-1)
                            targets[response.dashboard.rows[i].panels[j].datasource].push(response.dashboard.rows[i].panels[j].targets[k].target)
                      }
              }
              return targets
          }
      });

    </script>
</dom-module>
